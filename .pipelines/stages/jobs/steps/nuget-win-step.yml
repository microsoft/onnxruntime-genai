parameters:
- name: arch
  type: string
- name: ep
  type: string
- name: build_config
  type: string
- name: build_dir
  type: string
- name: id
  type: string
steps:
- powershell: |
    dotnet build Microsoft.ML.OnnxRuntimeGenAI.csproj -p:Configuration="${{ parameters.build_config }}" -p:NativeBuildOutputDir="${{ parameters.build_dir }}\${{ parameters.build_config }}"
  displayName: 'Build CSharp'
  workingDirectory: '$(Build.SourcesDirectory)\src\csharp'

- task: BinSkim@4
  displayName: 'Run BinSkim'
  inputs:
    AnalyzeTargetGlob: '$(Build.SourcesDirectory)\src\csharp\**\*.dll'
  continueOnError: true

- template: win-esrp-dll-step.yml
  parameters:
    FolderPath: '$(Build.SourcesDirectory)\src\csharp\bin\Release\'
    DisplayName: 'ESRP - Sign C# dlls'

- powershell: |
    $VERSION = '0.1.0-rc1'
    nuget.exe pack Microsoft.ML.OnnxRuntimeGenAI.nuspec `
      -Prop version=$VERSION `
      -Prop id=${{ parameters.id }} `
      -Prop configuration=${{ parameters.build_config }} `
      -Prop buildPath=${{ parameters.build_dir }}
    nuget.exe pack Microsoft.ML.OnnxRuntimeGenAI.Managed.nuspec `
      -Prop version=$VERSION `
      -Prop configuration=${{ parameters.build_config }}
  displayName: 'Nuget Packaging'
  workingDirectory: '$(Build.SourcesDirectory)\nuget'

- powershell: |
    Get-ChildItem -Path $(Build.SourcesDirectory) -Recurse
  displayName: 'List all files in the repo for ${{ parameters.arch }} ${{ parameters.ep }}'

- powershell: |
    Get-ChildItem -Path $(Build.SourcesDirectory) -Recurse
- task: CopyFiles@2
  displayName: 'Copy Nuget to: $(Build.ArtifactStagingDirectory)'
  inputs:
    SourceFolder: '$(Build.SourcesDirectory)\nuget'
    Contents: '*.nupkg'
    TargetFolder: '$(Build.ArtifactStagingDirectory)'